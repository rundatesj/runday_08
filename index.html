<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>러닝크루 월 마일리지 대결</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #e8eaf6 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            color: #374151;
            margin-bottom: 10px;
        }
        
        .setup-guide {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .forms-section {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .forms-container {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .forms-container h2 {
            color: #374151;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .dashboard-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .team-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .team-card {
            background: linear-gradient(135deg, #8b5cf6, #9333ea);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            position: relative;
        }
        
        .team-card.grape {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
        }
        
        .team-card h3 {
            font-size: 1.2rem;
            margin-bottom: 8px;
        }
        
        .team-score {
            font-size: 1.8rem;
            font-weight: bold;
        }
        
        .team-image {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid rgba(255,255,255,0.3);
        }
        
        .csv-setup {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .csv-setup input, .csv-setup textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            margin: 8px 0;
        }
        
        .btn {
            background: #10b981;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .btn:hover {
            background: #059669;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .chart-container h3 {
            color: #374151;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .chart-canvas {
            width: 100%;
            height: 250px;
        }
        
        .records-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .records-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        table th,
        table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.9rem;
        }
        
        table th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
        }
        
        .team-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .team-badge.milk {
            background: #ede9fe;
            color: #7c3aed;
        }
        
        .team-badge.grape {
            background: #e0e7ff;
            color: #4338ca;
        }
        
        .status {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            margin: 10px 0;
        }
        
        .status.success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status.error {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .status.warning {
            background: #fef3c7;
            color: #92400e;
        }
        
        .iframe-container {
            position: relative;
            width: 100%;
            height: 500px;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .iframe-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        @media (max-width: 768px) {
            .forms-section {
                grid-template-columns: 1fr;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .team-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 헤더 -->
        <div class="header">
            <h1>🏆 러닝크루 월 마일리지 대결</h1>
            <p>Team 우유 vs Team 포도 - Google Forms로 간편하게 기록하세요!</p>
        </div>

        <!-- Forms와 대시보드 -->
        <div class="forms-section">
            <!-- Google Forms 영역 -->
            <div class="forms-container">
                <h2>📝 러닝 기록 입력</h2>
                
                <!-- Forms 임베드 설정 -->
                <div class="csv-setup">
                    <label><strong>Google Forms 임베드 코드:</strong></label>
                    <textarea id="formsEmbed" placeholder='<iframe src="https://docs.google.com/forms/d/e/YOUR_FORM_ID/viewform?embedded=true" width="640" height="500" frameborder="0"></iframe>' style="height: 80px;"></textarea>
                    <button class="btn" onclick="embedForms()">Forms 연결</button>
                </div>
                
                <!-- Forms 표시 영역 -->
                <div class="iframe-container" id="forms-container">
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #6b7280; text-align: center;">
                        <div>
                            <p>👆 위에서 Google Forms 임베드 코드를 입력하고<br>"Forms 연결" 버튼을 클릭하세요.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 실시간 대시보드 -->
            <div class="dashboard-section">
                <h2>📊 실시간 현황</h2>
                
                <!-- CSV URL 설정 -->
                <div class="csv-setup">
                    <label><strong>스프레드시트 CSV URL:</strong></label>
                    <input type="url" id="csvUrl" placeholder="https://docs.google.com/spreadsheets/d/.../pub?output=csv">
                    <button class="btn" onclick="loadData()">데이터 로드</button>
                    <div id="status"></div>
                </div>

                <!-- 팀 점수 -->
                <div class="team-cards">
                    <div class="team-card">
                        <img src="https://raw.githubusercontent.com/rundatesj/Runday_2508/main/%EC%9A%B0%EC%9C%A0.jpg" 
                             alt="우유팀" class="team-image">
                        <h3>🥛 우유팀</h3>
                        <div class="team-score" id="milk-score">0 km</div>
                    </div>
                    <div class="team-card grape">
                        <img src="https://raw.githubusercontent.com/rundatesj/Runday_2508/main/%ED%8F%AC%EB%8F%84.jpg" 
                             alt="포도팀" class="team-image">
                        <h3>🍇 포도팀</h3>
                        <div class="team-score" id="grape-score">0 km</div>
                    </div>
                </div>

                <!-- 미니 차트 -->
                <div style="height: 200px; margin-bottom: 20px;">
                    <canvas id="miniChart"></canvas>
                </div>

                <!-- 최근 기록 (간소화) -->
                <div>
                    <h4>최근 기록</h4>
                    <table style="font-size: 0.8rem;">
                        <thead>
                            <tr>
                                <th>크루원</th>
                                <th>팀</th>
                                <th>거리</th>
                                <th>날짜</th>
                            </tr>
                        </thead>
                        <tbody id="recent-records">
                            <tr><td colspan="4" style="text-align: center; color: #6b7280;">데이터를 로드해주세요</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 상세 차트 -->
        <div class="charts-grid">
            <div class="chart-container">
                <h3>팀별 누적 기록</h3>
                <canvas id="teamChart" class="chart-canvas"></canvas>
            </div>
            <div class="chart-container">
                <h3>개인별 TOP 10</h3>
                <canvas id="personalChart" class="chart-canvas"></canvas>
            </div>
        </div>

        <!-- 전체 기록 -->
        <div class="records-section">
            <div class="records-header">
                <h3>전체 기록</h3>
                <button class="btn" onclick="loadData()">🔄 새로고침</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>크루원</th>
                        <th>팀</th>
                        <th>날짜</th>
                        <th>거리</th>
                        <th>입력시간</th>
                    </tr>
                </thead>
                <tbody id="all-records">
                    <tr><td colspan="5" style="text-align: center; color: #6b7280;">데이터를 로드해주세요</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // 크루원 데이터
        const crewMembers = {
            '우유': ['goinggoing', 'JS Jeon', 'NJ_Run', '거북아달려', '검단이봉주', '겨자색슈즈', '돌아온빵꾸', '마커스', '먕먐', '물냉명', '봉무동러너', '삼남매맘', '상우쌍우', '세동이', '신욱재', '우유키', '후니'],
            '포도': ['권초게', '라꾸라꾸조깅', '마이세트', '뭉공주', '바다', '삐약비약', '수다맘', '술우', '얼쑤야', '윤호근', '이응내', '자달매', '정영준', '하늘은평', '하하하양', '해피러너', '후다닭']
        };
        
        let records = [];
        let charts = {};
        
        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            // 로컬 스토리지에서 설정 불러오기
            const savedCsvUrl = localStorage.getItem('csvUrl');
            const savedFormsEmbed = localStorage.getItem('formsEmbed');
            
            if (savedCsvUrl) {
                document.getElementById('csvUrl').value = savedCsvUrl;
                loadData();
            }
            
            if (savedFormsEmbed) {
                document.getElementById('formsEmbed').value = savedFormsEmbed;
                embedForms();
            }
        });
        
        // Google Forms 임베드
        function embedForms() {
            const embedCode = document.getElementById('formsEmbed').value.trim();
            const container = document.getElementById('forms-container');
            
            if (!embedCode) {
                showStatus('error', 'Forms 임베드 코드를 입력해주세요.');
                return;
            }
            
            container.innerHTML = embedCode;
            localStorage.setItem('formsEmbed', embedCode);
            showStatus('success', 'Google Forms가 연결되었습니다!');
        }
        
        // 사용자 팀 찾기
        function findUserTeam(userId) {
            for (const [team, members] of Object.entries(crewMembers)) {
                if (members.includes(userId)) {
                    return team;
                }
            }
            return null;
        }
        
        // 데이터 로드
        async function loadData() {
            const csvUrl = document.getElementById('csvUrl').value.trim();
            
            if (!csvUrl) {
                showStatus('error', 'CSV URL을 입력해주세요.');
                return;
            }
            
            try {
                showStatus('warning', '데이터 로드 중...');
                
                const response = await fetch(csvUrl);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const csvText = await response.text();
                records = parseCSV(csvText);
                
                localStorage.setItem('csvUrl', csvUrl);
                showStatus('success', `${records.length}개 기록 로드 완료!`);
                updateUI();
                
            } catch (error) {
                showStatus('error', `로드 실패: ${error.message}`);
            }
        }
        
        // CSV 파싱 (개선된 버전)
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length <= 1) return [];
            
            const data = [];
            
            // 헤더 건너뛰고 데이터만 처리
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // 쉼표로 분할
                const columns = line.split(',');
                
                if (columns.length >= 4) {
                    const timestamp = columns[0] || '';
                    const userId = columns[1] || '';
                    const emptyTeam = columns[2] || ''; // 비어있는 team 컬럼
                    const date = columns[3] || '';
                    const distance = columns[4] || '';
                    
                    // userId가 있고 distance가 숫자인 경우만 처리
                    if (userId && distance && !isNaN(parseFloat(distance))) {
                        // findUserTeam으로 실제 팀 찾기
                        const team = findUserTeam(userId.trim());
                        
                        if (team) {
                            data.push({
                                timestamp: timestamp.trim(),
                                userId: userId.trim(),
                                team: team,
                                date: date.trim(),
                                distance: parseFloat(distance.trim())
                            });
                        }
                    }
                }
            }
            
            return data;
        }
        
        // 상태 표시
        function showStatus(type, message) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            
            if (type === 'success') {
                setTimeout(() => statusDiv.innerHTML = '', 3000);
            }
        }
        
        // UI 업데이트
        function updateUI() {
            updateTeamScores();
            updateCharts();
            updateTables();
        }
        
        // 팀 점수 업데이트
        function updateTeamScores() {
            const totals = { '우유': 0, '포도': 0 };
            records.forEach(r => totals[r.team] += r.distance);
            
            document.getElementById('milk-score').textContent = `${totals['우유'].toFixed(1)} km`;
            document.getElementById('grape-score').textContent = `${totals['포도'].toFixed(1)} km`;
        }
        
        // 차트 업데이트
        function updateCharts() {
            updateMiniChart();
            updateTeamChart();
            updatePersonalChart();
        }
        
        // 미니 차트
        function updateMiniChart() {
            const ctx = document.getElementById('miniChart').getContext('2d');
            
            if (charts.mini) charts.mini.destroy();
            
            const totals = { '우유': 0, '포도': 0 };
            records.forEach(r => totals[r.team] += r.distance);
            
            charts.mini = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['🥛 우유팀', '🍇 포도팀'],
                    datasets: [{
                        data: [totals['우유'], totals['포도']],
                        backgroundColor: ['#8b5cf6', '#6366f1']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }
        
        // 팀별 차트
        function updateTeamChart() {
            const ctx = document.getElementById('teamChart').getContext('2d');
            if (charts.team) charts.team.destroy();
            
            // 일별 누적 계산
            const dailyData = {};
            records.forEach(r => {
                // 날짜 정규화 (예: "2025. 8. 2" -> "2025-08-02")
                let normalizedDate = r.date.replace(/\./g, '-').replace(/\s+/g, '');
                if (!dailyData[normalizedDate]) dailyData[normalizedDate] = { '우유': 0, '포도': 0 };
                dailyData[normalizedDate][r.team] += r.distance;
            });
            
            const dates = Object.keys(dailyData).sort();
            let milkTotal = 0, grapeTotal = 0;
            
            const chartData = dates.map(date => {
                milkTotal += dailyData[date]['우유'];
                grapeTotal += dailyData[date]['포도'];
                return { date, milk: milkTotal, grape: grapeTotal };
            });
            
            charts.team = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.map(d => d.date),
                    datasets: [
                        { label: '🥛 우유팀', data: chartData.map(d => d.milk), backgroundColor: '#8b5cf6' },
                        { label: '🍇 포도팀', data: chartData.map(d => d.grape), backgroundColor: '#6366f1' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        }
        
        // 개인별 차트
        function updatePersonalChart() {
            const ctx = document.getElementById('personalChart').getContext('2d');
            if (charts.personal) charts.personal.destroy();
            
            const totals = {};
            records.forEach(r => totals[r.userId] = (totals[r.userId] || 0) + r.distance);
            
            const top10 = Object.entries(totals)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);
            
            charts.personal = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top10.map(([user]) => user),
                    datasets: [{
                        label: '누적 거리 (km)',
                        data: top10.map(([,total]) => total),
                        backgroundColor: top10.map(([user]) => findUserTeam(user) === '우유' ? '#8b5cf6' : '#6366f1')
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });
        }
        
        // 테이블 업데이트
        function updateTables() {
            // 최근 기록 (5개)
            const recentTbody = document.getElementById('recent-records');
            const recent = records.slice(-5).reverse();
            
            if (recent.length === 0) {
                recentTbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #6b7280;">기록이 없습니다</td></tr>';
            } else {
                recentTbody.innerHTML = recent.map(r => `
                    <tr>
                        <td>${r.userId}</td>
                        <td><span class="team-badge ${r.team === '우유' ? 'milk' : 'grape'}">${r.team === '우유' ? '🥛' : '🍇'}</span></td>
                        <td><strong>${r.distance}km</strong></td>
                        <td>${r.date}</td>
                    </tr>
                `).join('');
            }
            
            // 전체 기록
            const allTbody = document.getElementById('all-records');
            const all = records.slice().reverse();
            
            if (all.length === 0) {
                allTbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #6b7280;">기록이 없습니다</td></tr>';
            } else {
                allTbody.innerHTML = all.map(r => `
                    <tr>
                        <td>${r.userId}</td>
                        <td><span class="team-badge ${r.team === '우유' ? 'milk' : 'grape'}">${r.team === '우유' ? '🥛 우유팀' : '🍇 포도팀'}</span></td>
                        <td>${r.date}</td>
                        <td><strong>${r.distance} km</strong></td>
                        <td>${r.timestamp}</td>
                    </tr>
                `).join('');
            }
        }
    </script>
</body>
</html>