<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëŸ¬ë‹í¬ë£¨ ì›” ë§ˆì¼ë¦¬ì§€ ëŒ€ê²°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #e8eaf6 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            color: #374151;
            margin-bottom: 10px;
        }
        
        .setup-guide {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .forms-section {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .forms-container {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .forms-container h2 {
            color: #374151;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .dashboard-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .team-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .team-card {
            background: linear-gradient(135deg, #8b5cf6, #9333ea);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            position: relative;
        }
        
        .team-card.grape {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
        }
        
        .team-card h3 {
            font-size: 1.2rem;
            margin-bottom: 8px;
        }
        
        .team-score {
            font-size: 1.8rem;
            font-weight: bold;
        }
        
        .team-image {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid rgba(255,255,255,0.3);
        }
        
        .csv-setup {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .csv-setup input, .csv-setup textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            margin: 8px 0;
        }
        
        .btn {
            background: #10b981;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .btn:hover {
            background: #059669;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .chart-container h3 {
            color: #374151;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .chart-canvas {
            width: 100%;
            height: 250px;
        }
        
        .records-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .records-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        table th,
        table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.9rem;
        }
        
        table th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
        }
        
        .team-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .team-badge.milk {
            background: #ede9fe;
            color: #7c3aed;
        }
        
        .team-badge.grape {
            background: #e0e7ff;
            color: #4338ca;
        }
        
        .status {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            margin: 10px 0;
        }
        
        .status.success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status.error {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .status.warning {
            background: #fef3c7;
            color: #92400e;
        }
        
        .iframe-container {
            position: relative;
            width: 100%;
            height: 500px;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .iframe-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        @media (max-width: 768px) {
            .forms-section {
                grid-template-columns: 1fr;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .team-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- í—¤ë” -->
        <div class="header">
            <h1>ğŸ† ëŸ¬ë‹í¬ë£¨ ì›” ë§ˆì¼ë¦¬ì§€ ëŒ€ê²°</h1>
            <p>Team ìš°ìœ  vs Team í¬ë„ - Google Formsë¡œ ê°„í¸í•˜ê²Œ ê¸°ë¡í•˜ì„¸ìš”!</p>
        </div>

        <!-- Formsì™€ ëŒ€ì‹œë³´ë“œ -->
        <div class="forms-section">
            <!-- Google Forms ì˜ì—­ -->
            <div class="forms-container">
                <h2>ğŸ“ ëŸ¬ë‹ ê¸°ë¡ ì…ë ¥</h2>
                
                <!-- Forms ì„ë² ë“œ ì„¤ì • -->
                <div class="csv-setup">
                    <label><strong>Google Forms ì„ë² ë“œ ì½”ë“œ:</strong></label>
                    <textarea id="formsEmbed" placeholder='<iframe src="https://docs.google.com/forms/d/e/YOUR_FORM_ID/viewform?embedded=true" width="640" height="500" frameborder="0"></iframe>' style="height: 80px;"></textarea>
                    <button class="btn" onclick="embedForms()">Forms ì—°ê²°</button>
                </div>
                
                <!-- Forms í‘œì‹œ ì˜ì—­ -->
                <div class="iframe-container" id="forms-container">
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #6b7280; text-align: center;">
                        <div>
                            <p>ğŸ‘† ìœ„ì—ì„œ Google Forms ì„ë² ë“œ ì½”ë“œë¥¼ ì…ë ¥í•˜ê³ <br>"Forms ì—°ê²°" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œ -->
            <div class="dashboard-section">
                <h2>ğŸ“Š ì‹¤ì‹œê°„ í˜„í™©</h2>
                
                <!-- CSV URL ì„¤ì • -->
                <div class="csv-setup">
                    <label><strong>ìŠ¤í”„ë ˆë“œì‹œíŠ¸ CSV URL:</strong></label>
                    <input type="url" id="csvUrl" placeholder="https://docs.google.com/spreadsheets/d/.../pub?output=csv">
                    <button class="btn" onclick="loadData()">ë°ì´í„° ë¡œë“œ</button>
                    <div id="status"></div>
                </div>

                <!-- íŒ€ ì ìˆ˜ -->
                <div class="team-cards">
                    <div class="team-card">
                        <img src="https://raw.githubusercontent.com/rundatesj/Runday_2508/main/%EC%9A%B0%EC%9C%A0.jpg" 
                             alt="ìš°ìœ íŒ€" class="team-image">
                        <h3>ğŸ¥› ìš°ìœ íŒ€</h3>
                        <div class="team-score" id="milk-score">0 km</div>
                    </div>
                    <div class="team-card grape">
                        <img src="https://raw.githubusercontent.com/rundatesj/Runday_2508/main/%ED%8F%AC%EB%8F%84.jpg" 
                             alt="í¬ë„íŒ€" class="team-image">
                        <h3>ğŸ‡ í¬ë„íŒ€</h3>
                        <div class="team-score" id="grape-score">0 km</div>
                    </div>
                </div>

                <!-- ë¯¸ë‹ˆ ì°¨íŠ¸ -->
                <div style="height: 200px; margin-bottom: 20px;">
                    <canvas id="miniChart"></canvas>
                </div>

                <!-- ìµœê·¼ ê¸°ë¡ (ê°„ì†Œí™”) -->
                <div>
                    <h4>ìµœê·¼ ê¸°ë¡</h4>
                    <table style="font-size: 0.8rem;">
                        <thead>
                            <tr>
                                <th>í¬ë£¨ì›</th>
                                <th>íŒ€</th>
                                <th>ê±°ë¦¬</th>
                                <th>ë‚ ì§œ</th>
                            </tr>
                        </thead>
                        <tbody id="recent-records">
                            <tr><td colspan="4" style="text-align: center; color: #6b7280;">ë°ì´í„°ë¥¼ ë¡œë“œí•´ì£¼ì„¸ìš”</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ìƒì„¸ ì°¨íŠ¸ -->
        <div class="charts-grid">
            <div class="chart-container">
                <h3>íŒ€ë³„ ëˆ„ì  ê¸°ë¡</h3>
                <canvas id="teamChart" class="chart-canvas"></canvas>
            </div>
            <div class="chart-container">
                <h3>ê°œì¸ë³„ TOP 10</h3>
                <canvas id="personalChart" class="chart-canvas"></canvas>
            </div>
        </div>

        <!-- ì „ì²´ ê¸°ë¡ -->
        <div class="records-section">
            <div class="records-header">
                <h3>ì „ì²´ ê¸°ë¡</h3>
                <button class="btn" onclick="loadData()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>í¬ë£¨ì›</th>
                        <th>íŒ€</th>
                        <th>ë‚ ì§œ</th>
                        <th>ê±°ë¦¬</th>
                        <th>ì…ë ¥ì‹œê°„</th>
                    </tr>
                </thead>
                <tbody id="all-records">
                    <tr><td colspan="5" style="text-align: center; color: #6b7280;">ë°ì´í„°ë¥¼ ë¡œë“œí•´ì£¼ì„¸ìš”</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // í¬ë£¨ì› ë°ì´í„°
        const crewMembers = {
            'ìš°ìœ ': ['goinggoing', 'JS Jeon', 'NJ_Run', 'ê±°ë¶ì•„ë‹¬ë ¤', 'ê²€ë‹¨ì´ë´‰ì£¼', 'ê²¨ììƒ‰ìŠˆì¦ˆ', 'ëŒì•„ì˜¨ë¹µê¾¸', 'ë§ˆì»¤ìŠ¤', 'ë¨•ë¨', 'ë¬¼ëƒ‰ëª…', 'ë´‰ë¬´ë™ëŸ¬ë„ˆ', 'ì‚¼ë‚¨ë§¤ë§˜', 'ìƒìš°ìŒìš°', 'ì„¸ë™ì´', 'ì‹ ìš±ì¬', 'ìš°ìœ í‚¤', 'í›„ë‹ˆ'],
            'í¬ë„': ['ê¶Œì´ˆê²Œ', 'ë¼ê¾¸ë¼ê¾¸ì¡°ê¹…', 'ë§ˆì´ì„¸íŠ¸', 'ë­‰ê³µì£¼', 'ë°”ë‹¤', 'ì‚ì•½ë¹„ì•½', 'ìˆ˜ë‹¤ë§˜', 'ìˆ ìš°', 'ì–¼ì‘¤ì•¼', 'ìœ¤í˜¸ê·¼', 'ì´ì‘ë‚´', 'ìë‹¬ë§¤', 'ì •ì˜ì¤€', 'í•˜ëŠ˜ì€í‰', 'í•˜í•˜í•˜ì–‘', 'í•´í”¼ëŸ¬ë„ˆ', 'í›„ë‹¤ë‹­']
        };
        
        let records = [];
        let charts = {};
        
        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
            const savedCsvUrl = localStorage.getItem('csvUrl');
            const savedFormsEmbed = localStorage.getItem('formsEmbed');
            
            if (savedCsvUrl) {
                document.getElementById('csvUrl').value = savedCsvUrl;
                loadData();
            }
            
            if (savedFormsEmbed) {
                document.getElementById('formsEmbed').value = savedFormsEmbed;
                embedForms();
            }
        });
        
        // Google Forms ì„ë² ë“œ
        function embedForms() {
            const embedCode = document.getElementById('formsEmbed').value.trim();
            const container = document.getElementById('forms-container');
            
            if (!embedCode) {
                showStatus('error', 'Forms ì„ë² ë“œ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            container.innerHTML = embedCode;
            localStorage.setItem('formsEmbed', embedCode);
            showStatus('success', 'Google Formsê°€ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }
        
        // ì‚¬ìš©ì íŒ€ ì°¾ê¸°
        function findUserTeam(userId) {
            for (const [team, members] of Object.entries(crewMembers)) {
                if (members.includes(userId)) {
                    return team;
                }
            }
            return null;
        }
        
        // ë°ì´í„° ë¡œë“œ
        async function loadData() {
            const csvUrl = document.getElementById('csvUrl').value.trim();
            
            if (!csvUrl) {
                showStatus('error', 'CSV URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                showStatus('warning', 'ë°ì´í„° ë¡œë“œ ì¤‘...');
                
                const response = await fetch(csvUrl);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const csvText = await response.text();
                records = parseCSV(csvText);
                
                localStorage.setItem('csvUrl', csvUrl);
                showStatus('success', `${records.length}ê°œ ê¸°ë¡ ë¡œë“œ ì™„ë£Œ!`);
                updateUI();
                
            } catch (error) {
                showStatus('error', `ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
            }
        }
        
        // CSV íŒŒì‹± (ê°œì„ ëœ ë²„ì „)
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length <= 1) return [];
            
            const data = [];
            
            // í—¤ë” ê±´ë„ˆë›°ê³  ë°ì´í„°ë§Œ ì²˜ë¦¬
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // ì‰¼í‘œë¡œ ë¶„í• 
                const columns = line.split(',');
                
                if (columns.length >= 4) {
                    const timestamp = columns[0] || '';
                    const userId = columns[1] || '';
                    const emptyTeam = columns[2] || ''; // ë¹„ì–´ìˆëŠ” team ì»¬ëŸ¼
                    const date = columns[3] || '';
                    const distance = columns[4] || '';
                    
                    // userIdê°€ ìˆê³  distanceê°€ ìˆ«ìì¸ ê²½ìš°ë§Œ ì²˜ë¦¬
                    if (userId && distance && !isNaN(parseFloat(distance))) {
                        // findUserTeamìœ¼ë¡œ ì‹¤ì œ íŒ€ ì°¾ê¸°
                        const team = findUserTeam(userId.trim());
                        
                        if (team) {
                            data.push({
                                timestamp: timestamp.trim(),
                                userId: userId.trim(),
                                team: team,
                                date: date.trim(),
                                distance: parseFloat(distance.trim())
                            });
                        }
                    }
                }
            }
            
            return data;
        }
        
        // ìƒíƒœ í‘œì‹œ
        function showStatus(type, message) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            
            if (type === 'success') {
                setTimeout(() => statusDiv.innerHTML = '', 3000);
            }
        }
        
        // UI ì—…ë°ì´íŠ¸
        function updateUI() {
            updateTeamScores();
            updateCharts();
            updateTables();
        }
        
        // íŒ€ ì ìˆ˜ ì—…ë°ì´íŠ¸
        function updateTeamScores() {
            const totals = { 'ìš°ìœ ': 0, 'í¬ë„': 0 };
            records.forEach(r => totals[r.team] += r.distance);
            
            document.getElementById('milk-score').textContent = `${totals['ìš°ìœ '].toFixed(1)} km`;
            document.getElementById('grape-score').textContent = `${totals['í¬ë„'].toFixed(1)} km`;
        }
        
        // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        function updateCharts() {
            updateMiniChart();
            updateTeamChart();
            updatePersonalChart();
        }
        
        // ë¯¸ë‹ˆ ì°¨íŠ¸
        function updateMiniChart() {
            const ctx = document.getElementById('miniChart').getContext('2d');
            
            if (charts.mini) charts.mini.destroy();
            
            const totals = { 'ìš°ìœ ': 0, 'í¬ë„': 0 };
            records.forEach(r => totals[r.team] += r.distance);
            
            charts.mini = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['ğŸ¥› ìš°ìœ íŒ€', 'ğŸ‡ í¬ë„íŒ€'],
                    datasets: [{
                        data: [totals['ìš°ìœ '], totals['í¬ë„']],
                        backgroundColor: ['#8b5cf6', '#6366f1']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }
        
        // íŒ€ë³„ ì°¨íŠ¸
        function updateTeamChart() {
            const ctx = document.getElementById('teamChart').getContext('2d');
            if (charts.team) charts.team.destroy();
            
            // ì¼ë³„ ëˆ„ì  ê³„ì‚°
            const dailyData = {};
            records.forEach(r => {
                // ë‚ ì§œ ì •ê·œí™” (ì˜ˆ: "2025. 8. 2" -> "2025-08-02")
                let normalizedDate = r.date.replace(/\./g, '-').replace(/\s+/g, '');
                if (!dailyData[normalizedDate]) dailyData[normalizedDate] = { 'ìš°ìœ ': 0, 'í¬ë„': 0 };
                dailyData[normalizedDate][r.team] += r.distance;
            });
            
            const dates = Object.keys(dailyData).sort();
            let milkTotal = 0, grapeTotal = 0;
            
            const chartData = dates.map(date => {
                milkTotal += dailyData[date]['ìš°ìœ '];
                grapeTotal += dailyData[date]['í¬ë„'];
                return { date, milk: milkTotal, grape: grapeTotal };
            });
            
            charts.team = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.map(d => d.date),
                    datasets: [
                        { label: 'ğŸ¥› ìš°ìœ íŒ€', data: chartData.map(d => d.milk), backgroundColor: '#8b5cf6' },
                        { label: 'ğŸ‡ í¬ë„íŒ€', data: chartData.map(d => d.grape), backgroundColor: '#6366f1' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        }
        
        // ê°œì¸ë³„ ì°¨íŠ¸
        function updatePersonalChart() {
            const ctx = document.getElementById('personalChart').getContext('2d');
            if (charts.personal) charts.personal.destroy();
            
            const totals = {};
            records.forEach(r => totals[r.userId] = (totals[r.userId] || 0) + r.distance);
            
            const top10 = Object.entries(totals)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);
            
            charts.personal = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top10.map(([user]) => user),
                    datasets: [{
                        label: 'ëˆ„ì  ê±°ë¦¬ (km)',
                        data: top10.map(([,total]) => total),
                        backgroundColor: top10.map(([user]) => findUserTeam(user) === 'ìš°ìœ ' ? '#8b5cf6' : '#6366f1')
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });
        }
        
        // í…Œì´ë¸” ì—…ë°ì´íŠ¸
        function updateTables() {
            // ìµœê·¼ ê¸°ë¡ (5ê°œ)
            const recentTbody = document.getElementById('recent-records');
            const recent = records.slice(-5).reverse();
            
            if (recent.length === 0) {
                recentTbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #6b7280;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
            } else {
                recentTbody.innerHTML = recent.map(r => `
                    <tr>
                        <td>${r.userId}</td>
                        <td><span class="team-badge ${r.team === 'ìš°ìœ ' ? 'milk' : 'grape'}">${r.team === 'ìš°ìœ ' ? 'ğŸ¥›' : 'ğŸ‡'}</span></td>
                        <td><strong>${r.distance}km</strong></td>
                        <td>${r.date}</td>
                    </tr>
                `).join('');
            }
            
            // ì „ì²´ ê¸°ë¡
            const allTbody = document.getElementById('all-records');
            const all = records.slice().reverse();
            
            if (all.length === 0) {
                allTbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #6b7280;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
            } else {
                allTbody.innerHTML = all.map(r => `
                    <tr>
                        <td>${r.userId}</td>
                        <td><span class="team-badge ${r.team === 'ìš°ìœ ' ? 'milk' : 'grape'}">${r.team === 'ìš°ìœ ' ? 'ğŸ¥› ìš°ìœ íŒ€' : 'ğŸ‡ í¬ë„íŒ€'}</span></td>
                        <td>${r.date}</td>
                        <td><strong>${r.distance} km</strong></td>
                        <td>${r.timestamp}</td>
                    </tr>
                `).join('');
            }
        }
    </script>
</body>
</html>